// ▼▼▼ 設定項目 ▼▼▼
const PARENT_FOLDER_ID = '1g2KR6-10w6XrhDQB5qei0Vm_6QiJSVfj'; 
const SPREADSHEET_ID = '10XaIjInvhmThe0yGDiaTVqUIpRJsKSL0GfAls4JrvYo';
// ▲▲▲ 設定項目 ▲▲▲

// --- ▼▼▼ 【！】CORS対策（これがないとGitHubから呼べない）▼▼▼ ---
// ブラウザからの「POSTしていいですか？」という事前確認（preflight）に応答する
function doOptions(e) {
  return ContentService.createTextOutput()
    .setHeader('Access-Control-Allow-Origin', '*') // すべてのドメインを許可
    .setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS')
    .setHeader('Access-Control-Allow-Headers', 'Content-Type');
}
// --- ▲▲▲ 【！】CORS対策 ▲▲▲ ---

function doGet(e) {
  return HtmlService.createHtmlOutput("<p>電子署名システムのバックエンドです。正しく設定されています。</p>");
}

function doPost(e) {
  Logger.log('Received POST request.');
  let postData;
  let dataString;

  try {
    if (e.postData && e.postData.contents) {
      dataString = e.postData.contents;
    } else {
      throw new Error('No valid POST data found.');
    }
    
    postData = JSON.parse(dataString);
    Logger.log('Parsed JSON data successfully.');

    const signatureImage = postData.signature.replace(/^data:image\/(png|jpeg);base64,/, "");
    const imageBlob = Utilities.newBlob(Utilities.base64Decode(signatureImage), 'image/png', 'signature.png');

    const htmlContent = createHtmlForPdf(postData);
    const htmlBlob = Utilities.newBlob(htmlContent, MimeType.HTML, 'temp.html');
    const pdfBlob = htmlBlob.getAs(MimeType.PDF);

    const today = new Date();
    const formattedDate = Utilities.formatDate(today, 'JST', 'yyyy-MM-dd');
    const formattedTime = Utilities.formatDate(today, 'JST', 'HH-mm-ss');

    const parentFolder = DriveApp.getFolderById(PARENT_FOLDER_ID);
    
    let tenpoFolder;
    const tenpoFolders = parentFolder.getFoldersByName(postData.tenpo);
    if (tenpoFolders.hasNext()) {
      tenpoFolder = tenpoFolders.next();
    } else {
      tenpoFolder = parentFolder.createFolder(postData.tenpo);
    }
    
    let dateFolder;
    const dateFolders = tenpoFolder.getFoldersByName(formattedDate);
    if (dateFolders.hasNext()) {
      dateFolder = dateFolders.next();
    } else {
      dateFolder = tenpoFolder.createFolder(formattedDate);
    }
    
    const fileName = `${formattedTime}_${postData.torokuBango}_${postData.shataiBango}.pdf`;
    pdfBlob.setName(fileName);
    const pdfFile = dateFolder.createFile(pdfBlob);
    
    Logger.log('PDF created successfully. File URL: ' + pdfFile.getUrl());
    
    logToSpreadsheet(postData, pdfFile.getUrl());

    // --- ▼▼▼ 【！】CORS対策（レスポンスにも許可を追加）▼▼▼ ---
    return ContentService.createTextOutput(JSON.stringify({status: 'success', url: pdfFile.getUrl()}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin', '*'); // すべてのドメインを許可
    // --- ▲▲▲ 【！】CORS対策 ▲▲▲ ---

  } catch (err) {
    Logger.log('Error in doPost: ' + err.toString() + '\nStack: ' + err.stack);
    
    // --- ▼▼▼ 【！】CORS対策（エラー時にも許可を追加）▼▼▼ ---
    return ContentService.createTextOutput(JSON.stringify({status: 'error', message: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin', '*'); // すべてのドメインを許可
    // --- ▲▲▲ 【！】CORS対策 ▲▲▲ ---
  }
}

function logToSpreadsheet(data, pdfUrl) {
  // (この関数の中身は変更ありません)
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    if (data.formType === 'form-shaken') {
      const sheetName = '車検証同意';
      let sheet = ss.getSheetByName(sheetName);
      if (!sheet) {
        sheet = ss.insertSheet(sheetName);
        const headers = ['送付先郵便番号', '送付先住所', '送付先氏名/会社名', '所有者氏名', '連絡先TEL', 'タイムスタンプ', '店舗名', '受付スタッフ', '登録番号', '車台番号', 'PDFリンク'];
        sheet.appendRow(headers);
        sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
        sheet.setFrozenRows(1); 
      }
      const rowData = [data.zip, data.address, data.recipientName, data.ownerName, data.tel, data.timestamp, data.tenpo, data.staff, data.torokuBango, data.shataiBango, pdfUrl];
      sheet.appendRow(rowData);

    } else if (data.formType === 'form-houchi') {
      const sheetName = '放置違反';
      let sheet = ss.getSheetByName(sheetName);
      if (!sheet) {
        sheet = ss.insertSheet(sheetName);
        const headers = ['タイムスタンプ', '店舗名', '受付スタッフ', '登録番号', '車台番号', '車両タイプ', '委任承諾', '証明書承諾1', '証明書承諾2', 'PDFリンク'];
        sheet.appendRow(headers);
        sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
        sheet.setFrozenRows(1); 
      }
      const rowData = [data.timestamp, data.tenpo, data.staff, data.torokuBango, data.shataiBango, data.vehicleType, data.delegation ? 'はい' : 'いいえ', data.certificateType1 ? 'はい' : 'いいえ', data.certificateType2 ? 'はい' : 'いいえ', pdfUrl];
      sheet.appendRow(rowData);
    }
    Logger.log('Successfully logged to spreadsheet.');
  } catch (err) {
    Logger.log('Failed to log to spreadsheet: ' + err.toString());
  }
}

function createHtmlForPdf(data) {
  // (この関数の中身は変更ありません)
    const signatureImage = data.signature;
    let formSpecificHtml = '';
    let title = '';
    let yakkanHtml = `
        <h2 style="font-size: 1.2em; margin-bottom: 5px;">約款本文</h2>
        <pre style="font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; font-size: 7px; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #eee; padding: 8px; background-color: #f9f9f9; max-height: 250px; overflow: hidden;">
${data.yakkanText || '約款テキストがありません'}
        </pre>
    `;

    if (data.formType === 'form-houchi') {
        title = '放置違反金滞納情報照会における同意書';
        formSpecificHtml = `
            <h3 style="font-size: 1.1em; margin-bottom: 5px;">承諾事項</h3>
            <h4 style="font-size: 1em; margin: 5px 0 2px 0;">１．車両タイプ</h4>
            <p style="padding-left: 10px; border: 1px solid #eee; background: #f9f9f9; font-size: 0.9em; margin: 0;">${data.vehicleTypeText || '未選択'}</p>
            <h4 style="font-size: 1em; margin: 10px 0 2px 0;">２．継続検査（車検）の電磁的方法による申請手続き</h4>
            <p style="padding-left: 10px; border: 1px solid #eee; background: #f9f9f9; font-size: 0.9em; margin: 2px 0;">${data.delegationText || '未承諾'}</p>
            <p style="padding-left: 10px; border: 1px solid #eee; background: #f9f9f9; font-size: 0.9em; margin: 2px 0;">${data.certificate1Text || '未承諾'}</p>
            <p style="padding-left: 10px; border: 1px solid #eee; background: #f9f9f9; font-size: 0.9em; margin: 2px 0;">${data.certificate2Text || '未承諾'}</p>
        `;
    } else if (data.formType === 'form-shaken') {
        title = '保安基準適合証発行時の車検証後日郵送に関する同意書';
        formSpecificHtml = `
            <h3 style="font-size: 1.1em; margin-bottom: 5px;">お客様情報</h3>
            <p><strong>所有者氏名:</strong> ${data.ownerName}</p>
            <p><strong>連絡先電話番号:</strong> ${data.tel}</p>
            <p><strong>送付先郵便番号:</strong> ${data.zip}</p>
            <p><strong>送付先住所:</strong> ${data.address}</p>
            <p><strong>送付先氏名/会社名:</strong> ${data.recipientName}</p>
        `;
    }

    return `
        <html>
        <head><style>
            body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; font-size: 10px; }
            h1, h2, h3 { border-bottom: 1px solid #ccc; padding-bottom: 3px; margin-top: 10px; }
            h1 { font-size: 1.5em; }
            p { margin: 4px 0; }
            .container { width: 95%; margin: auto; }
            .signature-box { border: 1px solid #000; padding: 5px; margin-top: 10px; page-break-inside: avoid; }
        </style></head>
        <body>
            <div class="container">
                <h1>${title}</h1>
                <p><strong>署名日時:</strong> ${data.timestamp}</p>
                <h2 style="font-size: 1.2em;">車両・店舗情報</h2>
                <p><strong>店舗名:</strong> ${data.tenpo}</p>
                <p><strong>受付スタッフ名:</strong> ${data.staff}</p>
                <p><strong>登録番号:</strong> ${data.torokuBango}</p>
                <p><strong>車台番号:</strong> ${data.shataiBango}</p>
                ${formSpecificHtml}
                ${yakkanHtml}
                <div class="signature-box">
                    <h3 style="font-size: 1.1em;">電子署名</h3>
                    <img src="${signatureImage}" style="max-width: 250px; height: auto;" />
                </div>
            </div>
        </body>
        </html>
    `;
}
