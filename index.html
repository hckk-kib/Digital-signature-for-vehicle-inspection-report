<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>車検受付同意書 電子署名システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fetch-jsonp@1.1.3/build/fetch-jsonp.min.js"></script>
    <style>
        /* カスタムスクロールバー */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .signature-pad-container { border: 2px dashed #ccc; border-radius: 0.5rem; position: relative; }
        
        /* ▼▼▼ 【！】ペンずれ対策 ▼▼▼ */
        canvas {
            width: 100%;
            height: 200px;
            display: block;
            touch-action: none; /* スマホやタブレットでの不要なスクロールを禁止 */
        }
        /* ▲▲▲ 【！】ペンずれ対策 ▲▲▲ */

        .saving-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .completed { background-color: #16a34a !important; color: white !important; cursor: not-allowed !important; }
        .waiting { background-color: #d1d5db !important; cursor: not-allowed !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">車検受付同意書 電子署名システム</h1>
            <p class="text-center text-gray-500 mt-2">同意書を選択し、必要事項をご入力の上、電子署名をお願いいたします。</p>
        </header>

        <div id="common-staff-inputs" class="bg-white shadow-md rounded-lg p-6 mb-8">
            <fieldset class="p-4 rounded-lg">
                <legend class="text-xl font-semibold text-gray-700 px-2">1. スタッフ入力欄</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div>
                            <label for="common-tenpo" class="block text-gray-700 font-semibold mb-2">店舗名</label>
                            <select id="common-tenpo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">選択してください</option>
                                <option value="麻生店">麻生店</option>
                                <option value="美しが丘店">美しが丘店</option>
                                <option value="日吉店">日吉店</option>
                              _（中略）_
                                <option value="川崎多摩店">川崎多摩店</option>
                            </select>
                        </div>
                        <div>
                            <label for="common-staff" class="block text-gray-700 font-semibold mb-2">受付スタッフ名</label>
                            <input type="text" id="common-staff" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="例：山田 太郎">
                        </div>
                        <div>
                            <label for="common-toroku-bango" class="block text-gray-700 font-semibold mb-2">登録番号</label>
                            <input type="text" id="common-toroku-bango" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="例：品川 300 あ 12-34">
                        </div>
          _（...フォームのHTMLは変更なし...）_
        </form>
    </div>

    <div id="saving-overlay" class="hidden saving-overlay">
        <div class="text-center">
            <div class="spinner"></div>
            <p class="text-white text-lg mt-4 font-semibold">PDFを作成し、Googleドライブに保存しています...</p>
        </div>
    </div>


    <script>
        // --- ▼▼▼ 【！】あなたのGASのURLに差し替えてください ▼▼▼ ---
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwvTnFbDaRboKPZEyPFVZFzJz-XwQ3pp8wLa89BqMqE2kqnbiEOEP9CmWXwd6lkizjB/exec'; 
        // --- ▲▲▲ 【！】あなたのGASのURLに差し替えてください ▲▲▲ ---

        let currentForm = null;
        let signaturePad = null;
        const houchiButton = document.getElementById('show-houchi-form');
        const shakenButton = document.getElementById('show-shaken-form');
        const houchiButtonText = houchiButton.querySelector('.button-text').innerHTML;
        const shakenButtonText = shakenButton.querySelector('.button-text').innerHTML;
        
        // --- ▼▼▼ 【！】'formShaken' の定義を追加 ▼▼▼ ---
        const shakenInputs = ['shaken-owner-name', 'shaken-tel', 'shaken-zip', 'shaken-address'];
        const formHouchi = document.getElementById('form-houchi');
        const formShaken = document.getElementById('form-shaken'); // <-- バグ修正！
        
        // --- 共通の署名セクションHTML ---
        const signatureHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-2">電子署名</h3>
            <p class="text-sm text-gray-500 mb-4">以下の枠内に、楷書でご署名をお願いいたします。</p>
            <div class="signature-pad-container">
                <canvas></canvas>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mt-4">
                <button type="button" onclick="hideCurrentForm()" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">選択に戻る</button>
                <button type="button" onclick="clearSignature()" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">書き直す</button>
                <button type="button" onclick="saveSignature()" id="save-button" disabled class="w-full md:w-1/2 flex-grow bg-indigo-300 text-white font-bold py-3 px-6 rounded-lg">同意して保存する</button>
            </div>
        `;
        
        // --- ▼▼▼ 【！】'input' イベントに統一済み ▼▼▼ ---
        function addShakenListeners() {
            formShaken.addEventListener('input', updateSaveButtonState);
            setupZipCodeListener();
        }

        function removeShakenListeners() {
            formShaken.removeEventListener('input', updateSaveButtonState);
            const zipEl = document.getElementById('shaken-zip');
            if (zipEl) {
                zipEl.removeEventListener('input', lookupAddress);
            }
        }
        
        function addHouchiListeners() {
            formHouchi.addEventListener('input', updateSaveButtonState);
        }

        function removeHouchiListeners() {
            formHouchi.removeEventListener('input', updateSaveButtonState);
        }
        // --- ▲▲▲ 【！】'input' イベントに統一済み ▲▲▲ ---

        // --- フォーム表示切り替え ---
        function showForm(formId) {
            document.getElementById('form-houchi').classList.add('hidden');
            document.getElementById('form-shaken').classList.add('hidden');
            
            const formElement = document.getElementById(formId);
            formElement.classList.remove('hidden');
            currentForm = formId;

            // --- ▼▼▼ 【！】自動スクロール機能 ▼▼▼ ---
            formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // --- ▲▲▲ 【！】自動スクロール機能 ▲▲▲ ---

            if (formId === 'form-houchi') {
                shakenButton.querySelector('.button-text').textContent = '待機中';
                shakenButton.classList.add('waiting');
                houchiButton.disabled = true;
                removeShakenListeners(); 
                addHouchiListeners();   
            } else {
                houchiButton.querySelector('.button-text').textContent = '待機中';
                houchiButton.classList.add('waiting');
                houchiButton.disabled = true;
                removeHouchiListeners(); 
                addShakenListeners();   
            }

            const signatureSectionId = `signature-section-${formId.split('-')[1]}`;
            const signatureSection = document.getElementById(signatureSectionId);
            signatureSection.innerHTML = signatureHTML;
            
            window.removeEventListener('resize', resizeCanvas);

            // --- ▼▼▼ 【！】ペンずれ対策（300ms遅延） ▼▼▼ ---
            setTimeout(() => {
                const canvas = signatureSection.querySelector('canvas');
    _（...中略...）_
            }, 300); // <-- 100msから300msに変更し、レイアウト確定を待つ
            // --- ▲▲▲ 【！】ペンずれ対策 ▲▲▲ ---
        }
        
        function hideCurrentForm() {
            if (currentForm) {
                document.getElementById(currentForm).classList.add('hidden');
                if (currentForm === 'form-houchi') { removeHouchiListeners(); } 
                else if (currentForm === 'form-shaken') { removeShakenListeners(); }
                currentForm = null;
            }
            checkCommonInputs();
        }

        // --- ▼▼▼ 【！】ペンずれ対策（高DPI対応）▼▼▼ ---
        // ★★★ ここを修正しました ★★★
        function resizeCanvas() {
            if (!signaturePad || !signaturePad.canvas) return;
            const canvas = signaturePad.canvas;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);

            // 既存の署名をバックアップ (v1.5.3はtoData()でOK)
            const data = signaturePad.toData();

            // CSSの表示サイズをキャンバスの内部解像度に設定
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            
            // ライブラリにキャンバスをリセットさせる (これで古いスケール等が消える)
            // 内部で _reset() が呼ばれる
            signaturePad.clear(); 

            // ★★★【重要】★★★
            // _reset() がコンテキストを初期化（スケールも解除）してしまうため、
            // clear() の *後* で、再度スケールを設定する
            canvas.getContext("2d").scale(ratio, ratio);

            // データを書き戻す (新しいスケールが適用された状態で)
            signaturePad.fromData(data);
        }
        // --- ▲▲▲ 【！】ペンずれ対策（高DPI対応）▲▲▲ ---
        
        function isHouchiFormValid() {
    _（...残りのJavaScriptは変更なし...）_
        // 初期チェック
        checkCommonInputs();
    </script>
</body>
</html>
