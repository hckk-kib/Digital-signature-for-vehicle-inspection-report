<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>車検受付同意書 電子署名システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fetch-jsonp@1.1.3/build/fetch-jsonp.min.js"></script>
    <style>
        /* カスタムスクロールバー */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .signature-pad-container {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 200px;
            display: block;
        }
        .saving-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 完了したボタンのスタイル */
        .completed {
            background-color: #16a34a !important; /* Tailwind green-600 */
            color: white !important;
            cursor: not-allowed !important;
        }
        /* 待機中のボタンのスタイル */
        .waiting {
            background-color: #d1d5db !important; /* Tailwind gray-300 */
            cursor: not-allowed !important;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">車検受付同意書 電子署名システム</h1>
            <p class="text-center text-gray-500 mt-2">同意書を選択し、必要事項をご入力の上、電子署名をお願いいたします。</p>
        </header>

        <!-- スタッフ共通入力欄 -->
        <div id="common-staff-inputs" class="bg-white shadow-md rounded-lg p-6 mb-8">
            <fieldset class="p-4 rounded-lg">
                <legend class="text-xl font-semibold text-gray-700 px-2">1. スタッフ入力欄</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                     <div>
                        <label for="common-tenpo" class="block text-gray-700 font-semibold mb-2">店舗名</label>
                        <select id="common-tenpo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">選択してください</option>
                            <option value="麻生店">麻生店</option>
                            <option value="美しが丘店">美しが丘店</option>
                            <option value="日吉店">日吉店</option>
                            <option value="都筑桜並木店">都筑桜並木店</option>
                            <option value="川崎幸店">川崎幸店</option>
                            <option value="新百合ヶ丘店">新百合ヶ丘店</option>
                            <option value="鷺沼店">鷺沼店</option>
                            <option value="高津店">高津店</option>
                            <option value="綱島店">綱島店</option>
                            <option value="向ヶ丘店">向ヶ丘店</option>
                            <option value="岸根公園店">岸根公園店</option>
                            <option value="すみれが丘店">すみれが丘店</option>
                            <option value="あざみ野店">あざみ野店</option>
                            <option value="U-Select鶴見">U-Select鶴見</option>
                            <option value="U-Select川崎北">U-Select川崎北</option>
                            <option value="U-Select横浜青葉">U-Select横浜青葉</option>
                            <option value="青葉店">青葉店</option>
                            <option value="川崎多摩店">川崎多摩店</option>
                        </select>
                    </div>
                    <div>
                        <label for="common-staff" class="block text-gray-700 font-semibold mb-2">受付スタッフ名</label>
                        <input type="text" id="common-staff" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="例：山田 太郎">
                    </div>
                    <div>
                        <label for="common-toroku-bango" class="block text-gray-700 font-semibold mb-2">登録番号</label>
                        <input type="text" id="common-toroku-bango" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="例：品川 300 あ 12-34">
                    </div>
                    <div>
                        <label for="common-shatai-bango" class="block text-gray-700 font-semibold mb-2">車台番号</label>
                        <input type="text" id="common-shatai-bango" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="例：NCP58-1234567">
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- 同意書選択 -->
        <div id="form-selector" class="bg-white shadow-md rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-gray-700">2. 同意書の選択</h2>
                 <button id="reset-all-button" onclick="resetAll()" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">最初からやり直す</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4">
                <button id="show-houchi-form" onclick="showForm('form-houchi')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <span class="button-text">放置違反金滞納情報照会における同意書</span>
                </button>
                <button id="show-shaken-form" onclick="showForm('form-shaken')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                     <span class="button-text">保安基準適合証発行時の<br>車検証後日郵送に関する同意書</span>
                </button>
            </div>
        </div>

        <!-- 放置違反金照会制度の同意書フォーム -->
        <form id="form-houchi" class="hidden bg-white shadow-md rounded-lg p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 border-b-2 border-blue-200 pb-2">放置違反金滞納情報照会における同意書</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2 mt-8">約款</h3>
                    <div id="houchi-yakkan" class="h-48 border border-gray-300 rounded-lg p-4 overflow-y-auto custom-scrollbar bg-gray-50">
                        <p class="text-sm text-gray-600 whitespace-pre-line">
                            車検を受けられるお客様へ
継続検査（車検）のお手続きに際して下記事項についてご確認いただき、ご承諾下いますようご理解とご協力をお願い申し上げます。
１．放置違反金滞納情報照会について
平成１８年６月から、都道府県公安委員会（警察）が放置駐車違反の車両の使用者に放置違反金の納付を命ずる制度がスタートし、この命令を受
けたにもかかわらず、放置違反金を支払わないまま都道府県公安委員会から督促を受けた方は、これを納付しなければ、当該命令に係る自動車の次
回の車検（継続検査又は構造等変更検査）を完了することができないこととなりました（道路交通法第５１条の７第１項及び第２項）。
したがって、放置違反金を滞納されている方は、速やかにこれを納付し、その証明書を車検に際してご提示いただくようお願い申し上げます（納
付いただけない場合は、法令の規定により、都道府県公安委員会が行う滞納処分の対象となります。）。
納付書をお持ちでない方は、再発行いたしますので、各都道府県警察本部交通部にお問い合わせ下さい。
また、車検業務を円滑に完了するため、自動車整備事業者が皆様及び皆様のお車に関する情報を警察に照会し、
必要な確認を行う場合には、以下の同意書が必要となります。
                                                                                         警 察 庁
                                                                                         国 土 交 通 省
２．継続検査（車検）の電磁的方法による申請手続きについて
平成２９年４月より、継続検査（車検）に必要な書類の作成や申請手続きを電磁的方法により行うことが可能となりましたが、電磁的方法により
行う場合は、法令の規定により、事前にお客様（使用者）の承諾を頂くことが必要となっています。（法令の規定：道路運送車両法第９４条の５第
２項、同施行令第１０条及び自動車損害賠償保障法第９条第２項、同施行令第１条をいう。）
                        </p>
                    </div>
                </div>

                <!-- New Agreement Checkbox Section -->
                <div id="houchi-agreement-section" class="mt-6 space-y-4 border-t pt-6">
                    <p class="font-semibold text-gray-800">継続検査（車検）における確認事項及び承諾書</p>
                    
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="mb-3 text-sm text-gray-700">１．この度、継続検査等の申請を貴社（店）に依頼するにあたり、貴社（店）が私及び私の下記車両に係る放置違反金の滞納の有無に関する情報を（自動車整備振興会を通じて）警察に照会・確認することに同意します。<strong class="text-red-600">（いずれか1つを選択）</strong></p>
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2">
                            <label class="flex items-center"><input type="radio" name="houchi-vehicle-type" value="軽自動車" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2">軽自動車</span></label>
                            <label class="flex items-center"><input type="radio" name="houchi-vehicle-type" value="登録自動車" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2">登録自動車</span></label>
                            <label class="flex items-center"><input type="radio" name="houchi-vehicle-type" value="二輪車" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2">二輪車</span></label>
                        </div>
                    </div>
    
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="mb-3 text-sm text-gray-700">２．継続検査（車検）の電磁的方法による申請手続きに関してチェックを付けた事項について承諾します。</p>
                        <div class="pl-4 mt-2">
                            <label class="flex items-start">
                                <input type="checkbox" id="houchi-delegation" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                <span class="ml-2 text-sm">①〔継続検査（車検）申請に関する委任について〕<br>継続検査の申請を電磁的方法により行う場合、申請代理人に対し、申請に必要な情報を提供すること及び申請を委任すること。</span>
                            </label>
                        </div>
                        <div class="pl-4 mt-4">
                             <p class="mb-3 text-sm">②〔継続検査（車検）に際し民間が発行する証明書の取扱に関する承諾〕 <strong class="text-red-600">（両方にチェックが必要です）</strong></p>
                             <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="checkbox" id="houchi-certificate-1" value="保安基準適合証" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                    <span class="ml-2 text-sm">保安基準適合証の交付に代えて、当該証明書に記載すべき事項を電磁的方法により登録情報処理機関に提供すること。</span>
                                </label>
                                <label class="flex items-start">
                                    <input type="checkbox" id="houchi-certificate-2" value="自動車損害賠償責任保険証明書" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1 flex-shrink-0">
                                    <span class="ml-2 text-sm">自動車損害賠償責任保険証明書又は自動車損害賠償責任共済証明書に記載すべき事項を、電磁的方法により登録情報処理機関に提供すること。</span>
                                </label>
                             </div>
                             <p class="text-xs text-gray-500 mt-4">※ 「電磁的方法」とは：紙による申請や関係書類の国への提出に代えて、電子データにより国へ送信するものです。なお、当該電子データは、継続検査（車検）の手続き以外には使用されません</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 共通の署名と保存ボタン -->
            <div id="signature-section-houchi" class="mt-8"></div>
        </form>

        <!-- 車検証送付同意書フォーム -->
        <form id="form-shaken" class="hidden bg-white shadow-md rounded-lg p-6 md:p-8 mb-8">
            <h2 class="text-2xl font-bold text-green-800 mb-6 border-b-2 border-green-200 pb-2">保安基準適合証発行時の車検証後日郵送に関する同意書</h2>

            <!-- ユーザー入力欄 -->
             <fieldset class="border border-gray-300 p-4 rounded-lg">
                <legend class="text-lg font-semibold text-gray-600 px-2">お客様入力欄</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label for="shaken-owner-name" class="block text-gray-700 font-semibold mb-2">所有者氏名 <span class="text-red-500">*</span></label>
                        <input type="text" id="shaken-owner-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例：鈴木 一郎">
                    </div>
                    <div>
                        <label for="shaken-tel" class="block text-gray-700 font-semibold mb-2">連絡先電話番号 <span class="text-red-500">*</span></label>
                        <input type="tel" id="shaken-tel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例：090-1234-5678">
                    </div>
                    <div>
                        <label for="shaken-zip" class="block text-gray-700 font-semibold mb-2">送付先 郵便番号 <span class="text-red-500">*</span></label>
                        <input type="text" id="shaken-zip" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="例：1000001 (ハイフンなし)">
                    </div>
                     <div class="md:col-span-2">
                        <label for="shaken-address" class="block text-gray-700 font-semibold mb-2">送付先 住所 <span class="text-red-500">*</span></label>
                        <input type="text" id="shaken-address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="郵便番号を入力すると自動入力されます">
                        <p id="address-status" class="text-sm text-blue-600 mt-1 h-4"></p>
                    </div>
                     <div class="md:col-span-2">
                        <label for="shaken-recipient-name" class="block text-gray-700 font-semibold mb-2">送付先 氏名または会社名</label>
                        <input type="text" id="shaken-recipient-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="（所有者氏名と同じ場合は空欄で可）">
                    </div>
                </div>
            </fieldset>

            <div class="mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">車検証発送に関する約款・注意事項</h3>
                <div id="shaken-yakkan" class="h-48 border border-gray-300 rounded-lg p-4 overflow-y-auto custom-scrollbar bg-gray-50">
                    <p class="text-sm text-gray-600 whitespace-pre-line">
                        クリックラップ契約に関する注意事項：
                        お客様が以下の「電子署名」ボタンをクリックし、署名プロセスを完了した時点で、お客様は下記の「車検証発送に関する約款」の全条項に同意したものとみなされます。本契約は、電子消費者契約及び電子承諾通知に関する民法の特例に関する法律に基づき、有効に成立します。署名を行う前に、必ず約款の内容を十分にご確認ください。

                        --- 車検証発送に関する約款 ---
自動車検査証（車検証）について							
手元に届きましたら、氏名、住所、登録番号、車検証有効期限等の記載内容の確認をお願い致します。							
検査標章（車検ステッカー）について							
フロントガラスの室内側から、車検標章を貼り付けしてください。							
ステッカーの貼り付け方法につきましては、車検証と同封させて頂きます。							


保安基準適合章有効期限について							
保安基準適合章の有効期限は発行より2週間となります。							
有効期限が切れますと、お車の運行が出来ませんのでご注意下さい。							

また、車検証の積み忘れ、ステッカーの貼り忘れも同様に、お車の運行はできません。							

自動車検査証の発送に関して							
自動車検査証の発送に関してはレターパックライトを使用してお客様に送らせて頂きます。							
レターパックライトに関しては、お客様ご自宅へポストインさせて頂く配送方法となり、							
追跡番号を使用して配送状況を確認頂く事が出来ます。							
ポストに車検証が入らない場合には不在表が投函されますので、再配達のご連絡をお願いします。							
                    </p>
                </div>
                <p id="shaken-validation-notice" class="text-sm text-red-600 mt-2 font-semibold">お客様情報を全て入力すると署名が可能になります。</p>
            </div>

            <!-- 共通の署名と保存ボタン -->
            <div id="signature-section-shaken" class="mt-8"></div>
        </form>

    </div>

    <!-- 保存中オーバーレイ -->
    <div id="saving-overlay" class="hidden saving-overlay">
        <div class="text-center">
            <div class="spinner"></div>
            <p class="text-white text-lg mt-4 font-semibold">PDFを作成し、Googleドライブに保存しています...</p>
        </div>
    </div>


    <script>
        // --- グローバル変数 ---
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzkku00RexHFjTkQflVYIRpv-AYclNcbXH-URzahYatCa314KCcYyNOsbcGbX27QAxn/exec'; 

        let currentForm = null;
        let signaturePad = null;
        const houchiButton = document.getElementById('show-houchi-form');
        const shakenButton = document.getElementById('show-shaken-form');
        const houchiButtonText = houchiButton.querySelector('.button-text').innerHTML;
        const shakenButtonText = shakenButton.querySelector('.button-text').innerHTML;
        
        // --- 共通の署名セクションHTML ---
        const signatureHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-2">電子署名</h3>
            <p class="text-sm text-gray-500 mb-4">以下の枠内に、楷書でご署名をお願いいたします。</p>
            <div class="signature-pad-container">
                <canvas></canvas>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mt-4">
                <button type="button" onclick="hideCurrentForm()" class="w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">選択に戻る</button>
                <button type="button" onclick="clearSignature()" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">書き直す</button>
                <button type="button" onclick="saveSignature()" id="save-button" disabled class="w-full md:w-1/2 flex-grow bg-indigo-300 text-white font-bold py-3 px-6 rounded-lg">同意して保存する</button>
            </div>
        `;

        // --- フォーム表示切り替え ---
        function showForm(formId) {
            document.getElementById('form-houchi').classList.add('hidden');
            document.getElementById('form-shaken').classList.add('hidden');
            
            const formElement = document.getElementById(formId);
            formElement.classList.remove('hidden');
            currentForm = formId;

            if (formId === 'form-houchi') {
                shakenButton.querySelector('.button-text').textContent = '待機中';
                shakenButton.classList.add('waiting');
                houchiButton.disabled = true;
            } else {
                houchiButton.querySelector('.button-text').textContent = '待機中';
                houchiButton.classList.add('waiting');
                shakenButton.disabled = true;
            }

            const signatureSectionId = `signature-section-${formId.split('-')[1]}`;
            const signatureSection = document.getElementById(signatureSectionId);
            signatureSection.innerHTML = signatureHTML;
            
            window.removeEventListener('resize', resizeCanvas);

            setTimeout(() => {
                const canvas = signatureSection.querySelector('canvas');
                if (!canvas) return;
                signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
                window.addEventListener('resize', resizeCanvas);
                resizeCanvas();
            }, 0);

            if (formId === 'form-houchi') {
                formElement.addEventListener('change', updateSaveButtonState);
            } else if (formId === 'form-shaken') {
                formElement.addEventListener('input', updateSaveButtonState);
                setupZipCodeListener();
            }
            updateSaveButtonState();
        }
        
        function hideCurrentForm() {
            if (currentForm) {
                document.getElementById(currentForm).classList.add('hidden');
                currentForm = null;
            }
            if (!houchiButton.classList.contains('completed')) {
                houchiButton.querySelector('.button-text').innerHTML = houchiButtonText;
                houchiButton.classList.remove('waiting');
                houchiButton.disabled = false;
            }
             if (!shakenButton.classList.contains('completed')) {
                shakenButton.querySelector('.button-text').innerHTML = shakenButtonText;
                shakenButton.classList.remove('waiting');
                shakenButton.disabled = false;
            }
            checkCommonInputs(); 
        }

        function resizeCanvas() {
            if (!signaturePad || !signaturePad.canvas) return;
            const canvas = signaturePad.canvas;
            if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) return;
            const data = signaturePad.toData();
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.fromData(data);
        }
        
        function isHouchiFormValid() {
            const vehicleType = document.querySelector('input[name="houchi-vehicle-type"]:checked');
            const delegation = document.getElementById('houchi-delegation').checked;
            const certificate1 = document.getElementById('houchi-certificate-1').checked;
            const certificate2 = document.getElementById('houchi-certificate-2').checked;
            return !!vehicleType && delegation && certificate1 && certificate2;
        }

        function updateSaveButtonState() {
            const saveButton = document.getElementById('save-button');
            if (!saveButton) return;

            let isReady = false;
            if (currentForm === 'form-houchi') {
                isReady = isHouchiFormValid();
            } else if (currentForm === 'form-shaken') {
                const notice = document.getElementById('shaken-validation-notice');
                const ownerName = document.getElementById('shaken-owner-name').value.trim() !== '';
                const tel = document.getElementById('shaken-tel').value.trim() !== '';
                const zip = document.getElementById('shaken-zip').value.trim() !== '';
                const address = document.getElementById('shaken-address').value.trim() !== '';
                
                isReady = ownerName && tel && zip && address;

                if (notice) {
                    if (isReady) {
                        notice.style.display = 'none';
                    } else {
                        notice.style.display = 'block';
                        notice.textContent = '必須のお客様情報(*)を全て入力してください。';
                    }
                }
            }

            saveButton.disabled = !isReady;
            saveButton.classList.toggle('bg-indigo-300', !isReady);
            saveButton.classList.toggle('bg-indigo-600', isReady);
            saveButton.classList.toggle('hover:bg-indigo-700', isReady);
        }

        function clearSignature() {
            if (signaturePad) signaturePad.clear();
        }

        function setupZipCodeListener() {
            const zipInput = document.getElementById('shaken-zip');
            if (zipInput) {
                zipInput.addEventListener('input', lookupAddress);
            }
        }

        async function lookupAddress() {
            const zipInput = document.getElementById('shaken-zip');
            const addressInput = document.getElementById('shaken-address');
            const statusEl = document.getElementById('address-status');
            
            let zipCode = zipInput.value.replace(/[^0-9]/g, '');
            zipInput.value = zipCode;
            
            if (zipCode.length === 7) {
                statusEl.textContent = '住所を検索中...';
                try {
                    const response = await fetchJsonp(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zipCode}`);
                    const data = await response.json();
                    
                    if (data.status === 200 && data.results) {
                        const address = data.results[0].address1 + data.results[0].address2 + data.results[0].address3;
                        addressInput.value = address;
                        statusEl.textContent = '住所が自動入力されました。';
                        updateSaveButtonState();
                    } else {
                        statusEl.textContent = '該当する住所が見つかりませんでした。';
                    }
                } catch (error) {
                    console.error('Zip code lookup error:', error);
                    statusEl.textContent = '住所の検索に失敗しました。';
                }
            } else {
                statusEl.textContent = '';
            }
        }

        // データ送信（fetchを使用した安定版）
        async function saveSignature() {
            if (GAS_WEB_APP_URL.includes('...')) {
                alert('エラー：Google Apps ScriptのURLが設定されていません。\nHTMLファイル内の「GAS_WEB_APP_URL」を実際のURLに書き換えてください。');
                return;
            }
            if (signaturePad.isEmpty()) {
                alert("署名が入力されていません。");
                return;
            }

            let formData = {
                formType: currentForm,
                signature: signaturePad.toDataURL('image/png'),
                timestamp: new Date().toLocaleString('ja-JP'),
                tenpo: document.getElementById('common-tenpo').value,
                staff: document.getElementById('common-staff').value,
                torokuBango: document.getElementById('common-toroku-bango').value,
                shataiBango: document.getElementById('common-shatai-bango').value,
            };

            if (currentForm === 'form-houchi') {
                const vehicleTypeEl = document.querySelector('input[name="houchi-vehicle-type"]:checked');
                formData.vehicleType = vehicleTypeEl ? vehicleTypeEl.value : '';
                formData.delegation = document.getElementById('houchi-delegation').checked;
                formData.certificateType1 = document.getElementById('houchi-certificate-1').checked;
                formData.certificateType2 = document.getElementById('houchi-certificate-2').checked;
                formData.yakkanText = document.getElementById('houchi-yakkan').innerText;
            } else if (currentForm === 'form-shaken') {
                formData.ownerName = document.getElementById('shaken-owner-name').value;
                formData.tel = document.getElementById('shaken-tel').value;
                formData.zip = document.getElementById('shaken-zip').value;
                formData.address = document.getElementById('shaken-address').value;
                let recipient = document.getElementById('shaken-recipient-name').value;
                formData.recipientName = recipient || formData.ownerName;
                formData.yakkanText = document.getElementById('shaken-yakkan').innerText;
            }

            const overlay = document.getElementById('saving-overlay');
            overlay.classList.remove('hidden');

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // GASのシンプルなdoPostはCORSエラーを返すため、no-corsで送信に徹する
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // preflightを避けるためtext/plainで送信
                    },
                    body: JSON.stringify(formData),
                    redirect: 'follow'
                });

                // no-corsモードではレスポンスの中身は見れないが、ネットワークエラーがなければ成功と見なす
                overlay.classList.add('hidden');
                alert('保存リクエストを送信しました。\n数秒後、Googleドライブとスプレッドシートをご確認ください。');

                const completedButton = (currentForm === 'form-houchi') ? houchiButton : shakenButton;
                completedButton.classList.add('completed');
                completedButton.querySelector('.button-text').innerHTML = `✓ 完了`;
                completedButton.disabled = true;

                hideCurrentForm();
                document.getElementById('reset-all-button').classList.remove('hidden');

            } catch (error) {
                overlay.classList.add('hidden');
                console.error('Error:', error);
                alert(`保存中に通信エラーが発生しました。\n\n詳細: ${error.message}\n\nネットワーク接続を確認するか、GASのURL設定やデプロイ設定を見直してください。`);
            }
        }

        const commonInputs = [
            document.getElementById('common-tenpo'),
            document.getElementById('common-staff'),
            document.getElementById('common-toroku-bango'),
            document.getElementById('common-shatai-bango')
        ];
        
        function checkCommonInputs() {
            const allFilled = commonInputs.every(input => input.value.trim() !== '');
            if (!houchiButton.classList.contains('completed')) houchiButton.disabled = !allFilled;
            if (!shakenButton.classList.contains('completed')) shakenButton.disabled = !allFilled;
        }

        commonInputs.forEach(input => {
            input.addEventListener('input', checkCommonInputs);
        });
        
        function resetAll() {
            if (!confirm('全ての入力内容をリセットします。よろしいですか？')) return;

            commonInputs.forEach(input => input.value = '');
            document.getElementById('common-tenpo').selectedIndex = 0;
            
            if(currentForm) {
                // フォーム内の入力要素をリセット
                const form = document.getElementById(currentForm);
                if(form) form.reset();

                // 状態を初期化して非表示に
                hideCurrentForm();
            }

            houchiButton.classList.remove('completed', 'waiting');
            houchiButton.querySelector('.button-text').innerHTML = houchiButtonText;
            
            shakenButton.classList.remove('completed', 'waiting');
            shakenButton.querySelector('.button-text').innerHTML = shakenButtonText;

            document.getElementById('reset-all-button').classList.add('hidden');
            checkCommonInputs();
        }

        // 初期チェック
        checkCommonInputs();
    </script>
</body>
</html>

